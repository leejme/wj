{% extends "minimal_base.html" %}

{% block title %}æ•°æ®çœ‹æ¿ - ç»´é²¸è¿è¥ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- é¡µé¢æ ‡é¢˜å’Œç­›é€‰ -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="h2 fw-bold mb-2">æ•°æ®çœ‹æ¿</h1>
            <p class="text-gray-600">æŸ¥çœ‹ä»Šæ—¥æ±‡æ€»æ•°æ®åŠå„åº—é“ºè¡¨ç°</p>
        </div>
        <div class="d-flex gap-2">
            <input type="date" class="form-control search-input" id="dateSelect" value="{{ today }}" style="width: 180px;">
            <button class="btn btn-minimal btn-minimal-primary" onclick="loadDashboardData()">
                <i class="fas fa-search me-2"></i>æŸ¥è¯¢
            </button>
        </div>
    </div>

    <!-- ä»Šæ—¥ç»Ÿè®¡æ•°æ® -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="stat-card">
                <div class="stat-icon sales">
                    <i class="fas fa-money-bill-wave fa-lg"></i>
                </div>
                <div class="stat-value sales">Â¥{{ "%.2f"|format(all_shops_data.summary.total_sales) }}</div>
                <div class="stat-label">ä»Šæ—¥é”€å”®æ€»é¢</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card">
                <div class="stat-icon refunds">
                    <i class="fas fa-exchange-alt fa-lg"></i>
                </div>
                <div class="stat-value refunds">Â¥{{ "%.2f"|format(all_shops_data.summary.total_refunds) }}</div>
                <div class="stat-label">ä»Šæ—¥é€€æ¬¾æ€»é¢</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card">
                <div class="stat-icon subsidies">
                    <i class="fas fa-hand-holding-usd fa-lg"></i>
                </div>
                <div class="stat-value subsidies">Â¥{{ "%.2f"|format(all_shops_data.summary.total_subsidies) }}</div>
                <div class="stat-label">ä»Šæ—¥è¡¥è´´æ€»é¢</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card">
                <div class="stat-icon after-sales">
                    <i class="fas fa-headset fa-lg"></i>
                </div>
                <div class="stat-value after-sales">Â¥{{ "%.2f"|format(all_shops_data.summary.total_after_sales) }}</div>
                <div class="stat-label">ä»Šæ—¥å”®åèµ”ä»˜</div>
            </div>
        </div>
    </div>

    <!-- å„åº—é“ºæ•°æ®è¡¨æ ¼ -->
    <div class="minimal-card mb-4">
        <div class="minimal-card-header">
            <h4 class="mb-0">ğŸª å„åº—é“ºæ•°æ®æ±‡æ€» - {{ today }}</h4>
        </div>
        <div class="minimal-card-body">
            <div class="table-responsive">
                <table class="minimal-table">
                    <thead>
                        <tr>
                            <th>åº—é“ºåç§°</th>
                            <th>é”€å”®å›æ¬¾</th>
                            <th>é”€å”®å†²å›</th>
                            <th>éå•†è´£è¡¥è´´</th>
                            <th>å”®åèµ”ä»˜</th>
                            <th>å‡€æ”¶å…¥</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if all_shops_data.shops %}
                            {% for shop in all_shops_data.shops %}
                            <tr>
                                <td><strong>{{ shop.shop_name }}</strong></td>
                                <td class="sales">Â¥{{ "%.2f"|format(shop.total_sales) }}</td>
                                <td class="refunds">Â¥{{ "%.2f"|format(shop.total_refunds) }}</td>
                                <td class="subsidies">Â¥{{ "%.2f"|format(shop.total_subsidies) }}</td>
                                <td class="after-sales">Â¥{{ "%.2f"|format(shop.total_after_sales) }}</td>
                                <td>
                                    {% set net = shop.total_sales + shop.total_subsidies - shop.total_refunds - shop.total_after_sales %}
                                    {% if net >= 0 %}
                                        <span class="sales fw-bold">Â¥{{ "%.2f"|format(net) }}</span>
                                    {% else %}
                                        <span class="refunds fw-bold">Â¥{{ "%.2f"|format(net) }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            <!-- æ±‡æ€»è¡Œ -->
                            <tr class="table-active">
                                <td><strong>æ±‡æ€»</strong></td>
                                <td><strong class="sales">Â¥{{ "%.2f"|format(all_shops_data.summary.total_sales) }}</strong></td>
                                <td><strong class="refunds">Â¥{{ "%.2f"|format(all_shops_data.summary.total_refunds) }}</strong></td>
                                <td><strong class="subsidies">Â¥{{ "%.2f"|format(all_shops_data.summary.total_subsidies) }}</strong></td>
                                <td><strong class="after-sales">Â¥{{ "%.2f"|format(all_shops_data.summary.total_after_sales) }}</strong></td>
                                <td>
                                    {% set total_net = all_shops_data.summary.total_sales + all_shops_data.summary.total_subsidies - all_shops_data.summary.total_refunds - all_shops_data.summary.total_after_sales %}
                                    {% if total_net >= 0 %}
                                        <strong class="sales">Â¥{{ "%.2f"|format(total_net) }}</strong>
                                    {% else %}
                                        <strong class="refunds">Â¥{{ "%.2f"|format(total_net) }}</strong>
                                    {% endif %}
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <i class="fas fa-inbox fa-2x text-gray-300 mb-3"></i>
                                    <p class="text-gray-500">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆå¯¼å…¥æ•°æ®</p>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸï¼ˆå ä½ï¼‰ -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="minimal-card">
                <div class="minimal-card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>é”€å”®è¶‹åŠ¿å›¾</h5>
                </div>
                <div class="minimal-card-body">
                    <div style="height: 300px; background-color: var(--gray-50); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--gray-400);">
                        <div class="text-center">
                            <i class="fas fa-chart-bar fa-3x mb-3"></i>
                            <p>é”€å”®è¶‹åŠ¿å›¾ï¼ˆå¾…å¼€å‘ï¼‰</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="minimal-card">
                <div class="minimal-card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>åº—é“ºå æ¯”å›¾</h5>
                </div>
                <div class="minimal-card-body">
                    <div style="height: 300px; background-color: var(--gray-50); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--gray-400);">
                        <div class="text-center">
                            <i class="fas fa-chart-pie fa-3x mb-3"></i>
                            <p>åº—é“ºå æ¯”å›¾ï¼ˆå¾…å¼€å‘ï¼‰</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadDashboardData() {
    const date = document.getElementById('dateSelect').value;
    window.location.href = `/dashboard?date=${date}`;
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('dateSelect');
    if (!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
});
</script>
{% endblock %}
EOF