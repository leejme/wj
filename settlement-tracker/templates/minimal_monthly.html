{% extends "minimal_base.html" %}

{% block title %}æœˆåº¦æ±‡æ€» - ç»´é²¸è¿è¥ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- é¡µé¢æ ‡é¢˜å’Œç­›é€‰ -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="h2 fw-bold mb-2">æœˆåº¦æ±‡æ€»</h1>
            <p class="text-gray-600">æŸ¥çœ‹æœˆåº¦è¯¦ç»†æ•°æ®ç»Ÿè®¡</p>
        </div>
        <div class="d-flex gap-2">
            <select class="form-select search-input" id="shopSelect" style="width: 150px;">
                <option value="">æ‰€æœ‰åº—é“º</option>
                {% for shop in shops %}
                    {% if shop != "æ±‡æ€»" %}
                    <option value="{{ shop }}" {% if current_shop == shop %}selected{% endif %}>{{ shop }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <input type="number" class="form-control search-input" id="yearSelect" placeholder="å¹´ä»½" value="{{ current_year }}" style="width: 120px;">
            <select class="form-select search-input" id="monthSelect" style="width: 120px;">
                <option value="1" {% if current_month == "1" %}selected{% endif %}>1æœˆ</option>
                <option value="2" {% if current_month == "2" %}selected{% endif %}>2æœˆ</option>
                <option value="3" {% if current_month == "3" %}selected{% endif %}>3æœˆ</option>
                <option value="4" {% if current_month == "4" %}selected{% endif %}>4æœˆ</option>
                <option value="5" {% if current_month == "5" %}selected{% endif %}>5æœˆ</option>
                <option value="6" {% if current_month == "6" %}selected{% endif %}>6æœˆ</option>
                <option value="7" {% if current_month == "7" %}selected{% endif %}>7æœˆ</option>
                <option value="8" {% if current_month == "8" %}selected{% endif %}>8æœˆ</option>
                <option value="9" {% if current_month == "9" %}selected{% endif %}>9æœˆ</option>
                <option value="10" {% if current_month == "10" %}selected{% endif %}>10æœˆ</option>
                <option value="11" {% if current_month == "11" %}selected{% endif %}>11æœˆ</option>
                <option value="12" {% if current_month == "12" %}selected{% endif %}>12æœˆ</option>
            </select>
            <button class="btn btn-minimal btn-minimal-primary" onclick="loadMonthlyData()">
                <i class="fas fa-search me-2"></i>æŸ¥è¯¢
            </button>
        </div>
    </div>

    <!-- æœˆåº¦ç»Ÿè®¡æ•°æ® -->
    {% if summary %}
    <div class="minimal-card mb-4">
        <div class="minimal-card-header">
            <h4 class="mb-0">ğŸ“Š {{ current_shop }} - {{ summary.month }} æœˆåº¦æ±‡æ€»</h4>
        </div>
        <div class="minimal-card-body">
            <!-- æœˆåº¦ç»Ÿè®¡å¡ç‰‡ -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon sales">
                            <i class="fas fa-money-bill-wave fa-lg"></i>
                        </div>
                        <div class="stat-value sales">Â¥{{ "%.2f"|format(summary.monthly_totals.sales) }}</div>
                        <div class="stat-label">é”€å”®å›æ¬¾æ€»é¢</div>
                        <div class="stat-subtext">{{ summary.monthly_totals.total_sales_count }} ç¬”</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon refunds">
                            <i class="fas fa-exchange-alt fa-lg"></i>
                        </div>
                        <div class="stat-value refunds">Â¥{{ "%.2f"|format(summary.monthly_totals.refunds) }}</div>
                        <div class="stat-label">é”€å”®å†²å›æ€»é¢</div>
                        <div class="stat-subtext">{{ summary.monthly_totals.total_refunds_count }} ç¬”</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon subsidies">
                            <i class="fas fa-hand-holding-usd fa-lg"></i>
                        </div>
                        <div class="stat-value subsidies">Â¥{{ "%.2f"|format(summary.monthly_totals.subsidies) }}</div>
                        <div class="stat-label">éå•†è´£è¡¥è´´æ€»é¢</div>
                        <div class="stat-subtext">{{ summary.monthly_totals.total_subsidies_count }} ç¬”</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon after-sales">
                            <i class="fas fa-headset fa-lg"></i>
                        </div>
                        <div class="stat-value after-sales">Â¥{{ "%.2f"|format(summary.monthly_totals.after_sales) }}</div>
                        <div class="stat-label">å”®åèµ”ä»˜æ€»é¢</div>
                        <div class="stat-subtext">{{ summary.monthly_totals.total_after_sales_count }} ç¬”</div>
                    </div>
                </div>
            </div>

            <!-- æœˆåº¦å‡€æ”¶å…¥ -->
            <div class="alert alert-info mb-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-calculator fa-2x me-3"></i>
                    <div>
                        <h5 class="mb-1">æœˆåº¦å‡€æ”¶å…¥ç»Ÿè®¡</h5>
                        {% set total_income = summary.monthly_totals.sales + summary.monthly_totals.subsidies %}
                        {% set total_expense = summary.monthly_totals.refunds + summary.monthly_totals.after_sales %}
                        {% set net_income = total_income - total_expense %}
                        <p class="mb-0">
                            æ€»æ”¶å…¥: <strong class="sales">Â¥{{ "%.2f"|format(total_income) }}</strong> 
                            | æ€»æ”¯å‡º: <strong class="refunds">Â¥{{ "%.2f"|format(total_expense) }}</strong> 
                            | å‡€æ”¶å…¥: <strong class="{% if net_income >= 0 %}sales{% else %}refunds{% endif %}">Â¥{{ "%.2f"|format(net_income) }}</strong>
                        </p>
                    </div>
                </div>
            </div>

            <!-- æ¯æ—¥æ˜ç»†è¡¨æ ¼ -->
            <h5 class="mb-3">ğŸ“… æ¯æ—¥æ˜ç»†</h5>
            <div class="table-responsive">
                <table class="minimal-table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>é”€å”®å›æ¬¾</th>
                            <th>é”€å”®å†²å›</th>
                            <th>éå•†è´£è¡¥è´´</th>
                            <th>å”®åèµ”ä»˜</th>
                            <th>é”€å”®å•æ•°</th>
                            <th>é€€æ¬¾å•æ•°</th>
                            <th>æ—¥å‡€æ”¶å…¥</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for day in summary.daily_data %}
                        <tr>
                            <td>{{ day.date }}</td>
                            <td class="sales fw-medium">Â¥{{ "%.2f"|format(day.sales) }}</td>
                            <td class="refunds fw-medium">Â¥{{ "%.2f"|format(day.refunds) }}</td>
                            <td class="subsidies fw-medium">Â¥{{ "%.2f"|format(day.subsidies) }}</td>
                            <td class="after-sales fw-medium">Â¥{{ "%.2f"|format(day.after_sales) }}</td>
                            <td>{{ day.sales_count }}</td>
                            <td>{{ day.refunds_count }}</td>
                            <td class="fw-bold {% if (day.sales + day.subsidies - day.refunds - day.after_sales) >= 0 %}sales{% else %}refunds{% endif %}">
                                Â¥{{ "%.2f"|format(day.sales + day.subsidies - day.refunds - day.after_sales) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-calendar-alt fa-3x text-gray-300 mb-3"></i>
        <h5 class="text-gray-500 mb-2">æ²¡æœ‰æ‰¾åˆ°æœˆåº¦æ•°æ®</h5>
        <p class="text-gray-400">è¯·é€‰æ‹©åº—é“ºå’Œæœˆä»½è¿›è¡ŒæŸ¥è¯¢</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function loadMonthlyData() {
    const shop = document.getElementById('shopSelect').value;
    const year = document.getElementById('yearSelect').value;
    const month = document.getElementById('monthSelect').value;
    
    if (!shop) {
        alert('è¯·é€‰æ‹©åº—é“º');
        return;
    }
    
    if (!year || !month) {
        alert('è¯·é€‰æ‹©å¹´ä»½å’Œæœˆä»½');
        return;
    }
    
    window.location.href = `/monthly?shop=${shop}&year=${year}&month=${month}`;
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ—¥æœŸ
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    if (!document.getElementById('yearSelect').value) {
        document.getElementById('yearSelect').value = today.getFullYear();
    }
    if (!document.getElementById('monthSelect').value) {
        document.getElementById('monthSelect').value = today.getMonth() + 1;
    }
});
</script>
{% endblock %}
EOF