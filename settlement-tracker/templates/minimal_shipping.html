{% extends "minimal_base.html" %}

{% block title %}发货明细 - 维鲸运营系统{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- 页面标题和筛选 -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="h2 fw-bold mb-2">发货明细</h1>
            <p class="text-gray-600">查看和管理发货明细数据</p>
        </div>
        <div>
            <a href="/import" class="btn btn-minimal btn-minimal-primary">
                <i class="fas fa-plus me-2"></i>导入发货数据
            </a>
        </div>
    </div>

    <!-- 搜索筛选 -->
    <div class="minimal-card mb-4">
        <div class="minimal-card-body">
            <form id="shippingFilterForm" action="/shipping" method="get">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">店铺</label>
                        <select class="form-select search-input" name="shop">
                            <option value="">所有店铺</option>
                            {% for shop in shops %}
                                {% if shop != "汇总" %}
                                <option value="{{ shop }}" {% if current_shop == shop %}selected{% endif %}>{{ shop }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">备货单号</label>
                        <input type="text" class="form-control search-input" name="stock_order_id" placeholder="WB251016..." value="{{ stock_order_id }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">商品名称</label>
                        <input type="text" class="form-control search-input" name="product_name" placeholder="商品名称..." value="{{ product_name }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">日期范围</label>
                        <div class="d-flex gap-2">
                            <input type="date" class="form-control search-input" name="start_date" placeholder="开始日期" value="{{ start_date }}">
                            <input type="date" class="form-control search-input" name="end_date" placeholder="结束日期" value="{{ end_date }}">
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-4">
                    <button type="button" class="btn btn-minimal me-2" style="background-color: var(--gray-200); color: var(--gray-700);" onclick="resetFilter()">
                        <i class="fas fa-redo me-2"></i>重置
                    </button>
                    <button type="submit" class="btn btn-minimal btn-minimal-primary">
                        <i class="fas fa-search me-2"></i>搜索
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 发货明细列表 -->
    <div class="minimal-card">
        <div class="minimal-card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">发货明细列表</h4>
            <div>
                <span class="badge bg-primary">{{ shipping_data|length }} 条记录</span>
                {% if shipping_data|length > 0 %}
                <button class="btn btn-sm btn-minimal ms-2" onclick="exportShippingData()">
                    <i class="fas fa-download me-1"></i>导出
                </button>
                {% endif %}
            </div>
        </div>
        <div class="minimal-card-body">
            {% if shipping_data|length > 0 %}
            <div class="table-responsive">
                <table class="minimal-table">
                    <thead>
                        <tr>
                            <th>店铺</th>
                            <th>备货单号</th>
                            <th>商品名称</th>
                            <th>规格</th>
                            <th>SPU ID</th>
                            <th>SKU ID</th>
                            <th>数量</th>
                            <th>单价</th>
                            <th>总金额</th>
                            <th>发货日期</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in shipping_data %}
                        <tr>
                            <td>{{ item.shop_name }}</td>
                            <td><code>{{ item.stock_order_id }}</code></td>
                            <td>{{ item.product_name }}</td>
                            <td><span class="badge-minimal" style="background-color: var(--gray-100); color: var(--gray-700);">{{ item.sku_attribute }}</span></td>
                            <td><small class="text-gray-500">{{ item.spu_id }}</small></td>
                            <td><small class="text-gray-500">{{ item.sku_id }}</small></td>
                            <td><span class="fw-medium">{{ item.quantity }}</span></td>
                            <td class="text-gray-600">¥{{ "%.2f"|format(item.unit_price) }}</td>
                            <td class="fw-bold">¥{{ "%.2f"|format(item.total_amount) }}</td>
                            <td><span class="text-gray-500">{{ item.shipping_date }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- 统计信息 -->
            <div class="mt-4 pt-4 border-top">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <div class="text-center p-2 border rounded">
                            <div class="fw-bold text-primary">{{ total_quantity }}</div>
                            <div class="text-gray-600 small">总件数</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-2">
                        <div class="text-center p-2 border rounded">
                            <div class="fw-bold text-success">¥{{ "%.2f"|format(total_amount) }}</div>
                            <div class="text-gray-600 small">总金额</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-2">
                        <div class="text-center p-2 border rounded">
                            <div class="fw-bold text-warning">{{ unique_orders }}</div>
                            <div class="text-gray-600 small">备货单数</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-2">
                        <div class="text-center p-2 border rounded">
                            <div class="fw-bold text-info">{{ unique_products }}</div>
                            <div class="text-gray-600 small">商品种类</div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-shipping-fast fa-3x text-gray-300 mb-3"></i>
                <h5 class="text-gray-500 mb-2">没有找到发货明细</h5>
                <p class="text-gray-400 mb-4">请先导入发货数据或修改筛选条件</p>
                <a href="/import" class="btn btn-minimal btn-minimal-primary">
                    <i class="fas fa-upload me-2"></i>导入发货数据
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function resetFilter() {
    document.getElementById('shippingFilterForm').reset();
    window.location.href = '/shipping';
}

function exportShippingData() {
    // 构建导出URL
    const form = document.getElementById('shippingFilterForm');
    const params = new URLSearchParams(new FormData(form));
    window.open(`/export/shipping?${params.toString()}`, '_blank');
}
</script>
{% endblock %}
EOF