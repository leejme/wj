{% extends "minimal_base.html" %}

{% block title %}商品管理 - 维鲸运营系统{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="h2 fw-bold mb-2">商品管理</h1>
            <p class="text-gray-600">管理商品信息、价格及库存数据（修改会同步到发货明细，按 SPU 合并显示）</p>
        </div>
        <button class="btn btn-minimal btn-minimal-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
            <i class="fas fa-plus me-2"></i>添加商品
        </button>
    </div>

    <!-- 搜索和筛选 -->
    <div class="minimal-card mb-4">
        <div class="minimal-card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">店铺筛选</label>
                    <select class="form-select search-input" id="filterShop">
                        <option value="">所有店铺</option>
                        {% for shop in shops %}
                        {% if shop != "汇总" %}
                        <option value="{{ shop }}" {% if current_shop == shop %}selected{% endif %}>{{ shop }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">商品名称</label>
                    <input type="text" class="form-control search-input" id="filterName" placeholder="输入商品名称...">
                </div>
                <div class="col-md-4">
                    <label class="form-label">SPU ID</label>
                    <input type="text" class="form-control search-input" id="filterSpu" placeholder="输入SPU ID...">
                </div>
            </div>
            <div class="d-flex justify-content-end mt-3">
                <button class="btn btn-minimal btn-minimal-primary me-2" onclick="applyFilters()">
                    <i class="fas fa-search me-2"></i>搜索
                </button>
                <button class="btn btn-minimal" style="background-color: var(--gray-200); color: var(--gray-700);" onclick="resetFilters()">
                    <i class="fas fa-redo me-2"></i>重置
                </button>
            </div>
        </div>
    </div>

    <!-- 商品列表（按 SPU 合并） -->
    <div class="minimal-card">
        <div class="minimal-card-header">
            <h4 class="mb-0">商品列表（按 SPU 合并）</h4>
        </div>
        <div class="minimal-card-body">
            <div class="table-responsive">
                <table class="minimal-table" id="productsTable">
                    <thead>
                        <tr>
                            <th>店铺</th>
                            <th>SPU ID</th>
                            <th>商品名称</th>
                            <th>规格数</th>
                            <th>申报价格</th>
                            <th>成本单价</th>
                            <th>已售数量</th>
                            <th>申报额</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if products %}
                            {% for p in products %}
                            <tr data-spu="{{ p.spu_id }}" data-shop="{{ p.shop_name }}">
                                <td>{{ p.shop_name }}</td>
                                <td><code>{{ p.spu_id }}</code></td>
                                <td>
                                    <div style="max-width:320px;">
                                        <span class="d-inline-block text-truncate" style="max-width:300px;" title="{{ p.product_name }}">
                                            {{ p.product_name }}
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge-minimal" style="background-color: var(--gray-100); color: var(--gray-700);">
                                        {{ p.sku_count if p.sku_count is not none else 1 }}
                                    </span>
                                </td>
                                <td class="fw-bold text-success">¥{{ "%.2f"|format(p.unit_price if p.unit_price is not none else 0) }}</td>
                                <td class="text-gray-600">¥{{ "%.2f"|format(p.cost_price if p.cost_price is not none else 0) }}</td>
                                <td><span class="fw-medium">{{ p.total_sold if p.total_sold is not none else 0 }}</span></td>
                                <td class="fw-bold">¥{{ "%.2f"|format(p.total_sales_amount if p.total_sales_amount is not none else 0) }}</td>
                                <td>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm" style="background-color: rgba(37, 99, 235, 0.1); color: var(--primary-color);" onclick="openEditModal(this)">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm" style="background-color: rgba(239, 68, 68, 0.1); color: var(--danger-color);" onclick="deleteProduct('{{ p.spu_id }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="9" class="text-center py-5 text-gray-500">
                                <i class="fas fa-box-open fa-2x mb-3"></i><br>
                                暂无商品数据
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <!-- 分页占位 -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-gray-600">显示 1-10 条</div>
                <nav>
                    <ul class="pagination mb-0">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">上一页</a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">下一页</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- 编辑商品模态框（按 SPU 编辑） -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑商品（按 SPU）</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm" onsubmit="submitEdit(event)">
                    <input type="hidden" id="editShop">
                    <div class="mb-3">
                        <label class="form-label">SPU ID</label>
                        <input type="text" id="editSpu" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">商品名称</label>
                        <input type="text" id="editName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">申报价格 (¥)</label>
                        <input type="number" step="0.01" id="editUnitPrice" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">成本单价 (¥)</label>
                        <input type="number" step="0.01" id="editCostPrice" class="form-control" required>
                    </div>
                    <div class="form-text mb-2">
                        修改后会自动同步到该 SPU 在发货明细中的单价、申报额及商品名称（会应用到该 SPU 的所有规格）。
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-minimal" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-minimal btn-minimal-primary" onclick="submitEdit()">保存并同步</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加商品模态框（保留） -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加新商品</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">店铺</label>
                            <select class="form-select" required>
                                <option value="">选择店铺</option>
                                {% for shop in shops %}
                                {% if shop != "汇总" %}
                                <option value="{{ shop }}">{{ shop }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">SPU ID</label>
                            <input type="text" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">商品名称</label>
                            <input type="text" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">规格</label>
                            <input type="text" class="form-control" placeholder="例如：红色/M" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">申报价格</label>
                            <input type="number" class="form-control" step="0.01" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">成本单价</label>
                            <input type="number" class="form-control" step="0.01" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-minimal" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-minimal btn-minimal-primary">保存商品</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function applyFilters() {
    const shop = document.getElementById('filterShop').value;
    const name = document.getElementById('filterName').value;
    const spu = document.getElementById('filterSpu').value;
    let url = `/products?`;
    if (shop) url += `shop=${encodeURIComponent(shop)}&`;
    if (spu) url += `spu_id=${encodeURIComponent(spu)}&`;
    if (name) url += `product_name=${encodeURIComponent(name)}&`;
    window.location.href = url;
}

function resetFilters() {
    document.getElementById('filterShop').value = '';
    document.getElementById('filterName').value = '';
    document.getElementById('filterSpu').value = '';
    window.location.href = '/products';
}

// 打开编辑模态框，填充数据（按 SPU）
function openEditModal(btn) {
    const tr = btn.closest('tr');
    const spu = tr.dataset.spu || tr.querySelector('code')?.textContent;
    const shop = tr.dataset.shop || tr.querySelector('td')?.textContent.trim();
    const name = tr.querySelector('td:nth-child(3)')?.textContent.trim();
    const unitPriceText = tr.querySelector('td:nth-child(5)')?.textContent.replace('¥','').trim();
    const costPriceText = tr.querySelector('td:nth-child(6)')?.textContent.replace('¥','').trim();

    document.getElementById('editSpu').value = spu || '';
    document.getElementById('editShop').value = shop || '';
    document.getElementById('editName').value = name || '';
    document.getElementById('editUnitPrice').value = unitPriceText || 0;
    document.getElementById('editCostPrice').value = costPriceText || 0;

    new bootstrap.Modal(document.getElementById('editProductModal')).show();
}

// 提交编辑并调用 API，同步发货明细（按 SPU，sku_attribute 传空表示同步该 SPU 的所有规格）
function submitEdit(e) {
    if (e) e.preventDefault();
    const shop = document.getElementById('editShop').value;
    const spu = document.getElementById('editSpu').value;
    const name = document.getElementById('editName').value;
    const unitPrice = parseFloat(document.getElementById('editUnitPrice').value || 0);
    const costPrice = parseFloat(document.getElementById('editCostPrice').value || 0);

    if (!shop || !spu) {
        alert('缺少必要字段');
        return;
    }

    const payload = {
        shop_name: shop,
        spu_id: spu,
        sku_attribute: '',  // 空表示按 SPU 同步所有规格
        unit_price: unitPrice,
        cost_price: costPrice,
        product_name: name
    };

    fetch('/api/update_product_price', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.success) {
            alert('更新成功，已同步发货明细中的申报价格与商品信息');
            bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
            setTimeout(()=> location.reload(), 600);
        } else {
            alert('更新失败: ' + (data.error || JSON.stringify(data)));
        }
    })
    .catch(err => {
        console.error(err);
        alert('更新出错，请查看控制台');
    });
}

function deleteProduct(spu) {
    alert('删除功能暂未实现（演示）');
}

// 初始化页面时启用 tooltip（用于完整商品名显示）
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'))
    tooltipTriggerList.forEach(function (el) {
        new bootstrap.Tooltip(el, {container: 'body', trigger: 'hover'});
    })
});
</script>
{% endblock %}