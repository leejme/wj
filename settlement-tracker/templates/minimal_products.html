{% extends "minimal_base.html" %}

{% block title %}商品管理 - 维鲸运营系统{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="h2 fw-bold mb-2">商品管理</h1>
            <p class="text-gray-600">管理商品信息、价格及库存数据（支持分别编辑每个规格的价格）</p>
        </div>
        <button class="btn btn-minimal btn-minimal-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
            <i class="fas fa-plus me-2"></i>添加商品
        </button>
    </div>

    <!-- 搜索和筛选 -->
    <div class="minimal-card mb-4">
        <div class="minimal-card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">店铺筛选</label>
                    <select class="form-select search-input" id="filterShop">
                        <option value="">所有店铺</option>
                        {% for shop in shops %}
                        {% if shop != "汇总" %}
                        <option value="{{ shop }}" {% if current_shop == shop %}selected{% endif %}>{{ shop }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">商品名称</label>
                    <input type="text" class="form-control search-input" id="filterName" placeholder="输入商品名称..." value="{{ current_product_name }}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">SPU ID</label>
                    <input type="text" class="form-control search-input" id="filterSpu" placeholder="输入SPU ID..." value="{{ current_spu_id }}">
                </div>
            </div>
            <div class="d-flex justify-content-end mt-3">
                <button class="btn btn-minimal btn-minimal-primary me-2" onclick="applyFilters()">
                    <i class="fas fa-search me-2"></i>搜索
                </button>
                <button class="btn btn-minimal" style="background-color: var(--gray-200); color: var(--gray-700);" onclick="resetFilters()">
                    <i class="fas fa-redo me-2"></i>重置
                </button>
            </div>
        </div>
    </div>

    <!-- 商品列表（按规格显示） -->
    <div class="minimal-card">
        <div class="minimal-card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">商品列表（按规格显示）</h4>
            <div>
                <span class="badge bg-primary">{{ products|length }} 个规格</span>
            </div>
        </div>
        <div class="minimal-card-body">
            {% if products %}
            <div class="table-responsive">
                <table class="minimal-table" id="productsTable">
                    <thead>
                        <tr>
                            <th>店铺</th>
                            <th>SPU ID</th>
                            <th>商品名称</th>
                            <th>规格</th>
                            <th>SKU ID</th>
                            <th>申报价格</th>
                            <th>成本单价</th>
                            <th>已售数量</th>
                            <th>申报额</th>
                            <th>最后更新</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in products %}
                        <tr>
                            <td>{{ p.shop_name }}</td>
                            <td><code>{{ p.spu_id }}</code></td>
                            <td>
                                <div style="max-width:250px;">
                                    <span class="d-inline-block text-truncate" style="max-width:230px;" title="{{ p.product_name }}">
                                        {{ p.product_name }}
                                    </span>
                                </div>
                            </td>
                            <td>
                                <span class="badge-minimal" style="background-color: var(--gray-100); color: var(--gray-700);">
                                    {{ p.sku_attribute }}
                                </span>
                            </td>
                            <td><small class="text-gray-500">{{ p.sku_id }}</small></td>
                            <td class="fw-bold text-success">¥{{ "%.2f"|format(p.unit_price if p.unit_price is not none else 0) }}</td>
                            <td class="text-gray-600">¥{{ "%.2f"|format(p.cost_price if p.cost_price is not none else 0) }}</td>
                            <td><span class="fw-medium">{{ p.total_sold if p.total_sold is not none else 0 }}</span></td>
                            <td class="fw-bold">¥{{ "%.2f"|format(p.total_sales_amount if p.total_sales_amount is not none else 0) }}</td>
                            <td><small class="text-gray-500">{{ p.update_date[:10] if p.update_date else '' }}</small></td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm" style="background-color: rgba(37, 99, 235, 0.1); color: var(--primary-color);" onclick="openEditModal(this)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- 分页占位 -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-gray-600">显示 {{ products|length }} 个规格</div>
                <nav>
                    <ul class="pagination mb-0">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">上一页</a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">下一页</a>
                        </li>
                    </ul>
                </nav>
            </div>
            {% else %}
            <div class="text-center py-5 text-gray-500">
                <i class="fas fa-box-open fa-2x mb-3"></i><br>
                暂无商品数据
                <div class="mt-3">
                    <button class="btn btn-minimal btn-minimal-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                        <i class="fas fa-plus me-2"></i>添加第一个商品
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 编辑商品模态框（按规格编辑） -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑商品规格</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" id="editShop">
                    <input type="hidden" id="editSpuId">
                    <input type="hidden" id="editSkuAttribute">
                    <input type="hidden" id="editProductName">
                    
                    <div class="mb-3">
                        <label class="form-label">店铺</label>
                        <input type="text" id="editShopDisplay" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">SPU ID</label>
                        <input type="text" id="editSpuDisplay" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">商品名称</label>
                        <input type="text" id="editProductNameDisplay" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">规格</label>
                        <input type="text" id="editSkuAttributeDisplay" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">申报价格 (¥)</label>
                        <input type="number" step="0.01" id="editUnitPrice" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">成本单价 (¥)</label>
                        <input type="number" step="0.01" id="editCostPrice" class="form-control" required>
                    </div>
                    <div class="form-text mb-2">
                        修改后会自动同步到发货明细中的该规格单价和申报额。
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-minimal" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-minimal" style="background-color: rgba(245, 158, 11, 0.1); color: var(--warning-color);" onclick="syncShippingPrices()">
                    <i class="fas fa-sync me-1"></i>同步到发货明细
                </button>

                <button type="button" class="btn btn-minimal btn-minimal-primary" onclick="submitEdit()">保存并同步</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加商品模态框 -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加新商品</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">店铺</label>
                            <select class="form-select" id="addShop" required>
                                <option value="">选择店铺</option>
                                {% for shop in shops %}
                                {% if shop != "汇总" %}
                                <option value="{{ shop }}">{{ shop }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">SPU ID</label>
                            <input type="text" class="form-control" id="addSpuId" required>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">商品名称</label>
                            <input type="text" class="form-control" id="addProductName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">规格</label>
                            <input type="text" class="form-control" id="addSkuAttribute" placeholder="例如：红色/M" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">SKU ID</label>
                            <input type="text" class="form-control" id="addSkuId" placeholder="例如：SKU001">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">申报价格</label>
                            <input type="number" class="form-control" id="addUnitPrice" step="0.01" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">成本单价</label>
                            <input type="number" class="form-control" id="addCostPrice" step="0.01" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-minimal" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-minimal btn-minimal-primary" onclick="submitAddProduct()">保存商品</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function applyFilters() {
    const shop = document.getElementById('filterShop').value;
    const name = document.getElementById('filterName').value;
    const spu = document.getElementById('filterSpu').value;
    let url = `/products?`;
    if (shop) url += `shop=${encodeURIComponent(shop)}&`;
    if (spu) url += `spu_id=${encodeURIComponent(spu)}&`;
    if (name) url += `product_name=${encodeURIComponent(name)}&`;
    window.location.href = url;
}

function resetFilters() {
    window.location.href = '/products';
}

// 打开编辑模态框，填充数据
function openEditModal(btn) {
    const tr = btn.closest('tr');
    const cells = tr.querySelectorAll('td');
    
    const shop = cells[0].textContent.trim();
    const spu = cells[1].querySelector('code').textContent.trim();
    const productName = cells[2].textContent.trim();
    const skuAttribute = cells[3].querySelector('.badge-minimal').textContent.trim();
    const unitPriceText = cells[5].textContent.replace('¥','').trim();
    const costPriceText = cells[6].textContent.replace('¥','').trim();

    document.getElementById('editShop').value = shop;
    document.getElementById('editShopDisplay').value = shop;
    document.getElementById('editSpuId').value = spu;
    document.getElementById('editSpuDisplay').value = spu;
    document.getElementById('editProductName').value = productName;
    document.getElementById('editProductNameDisplay').value = productName;
    document.getElementById('editSkuAttribute').value = skuAttribute;
    document.getElementById('editSkuAttributeDisplay').value = skuAttribute;
    document.getElementById('editUnitPrice').value = unitPriceText || 0;
    document.getElementById('editCostPrice').value = costPriceText || 0;

    new bootstrap.Modal(document.getElementById('editProductModal')).show();
}

// 提交编辑并调用 API
function submitEdit() {
    const shop = document.getElementById('editShop').value;
    const spu = document.getElementById('editSpuId').value;
    const skuAttribute = document.getElementById('editSkuAttribute').value;
    const productName = document.getElementById('editProductName').value;
    const unitPrice = parseFloat(document.getElementById('editUnitPrice').value || 0);
    const costPrice = parseFloat(document.getElementById('editCostPrice').value || 0);

    if (!shop || !spu || !skuAttribute) {
        alert('缺少必要字段');
        return;
    }

    const payload = {
        shop_name: shop,
        spu_id: spu,
        sku_attribute: skuAttribute,  // 指定具体规格
        unit_price: unitPrice,
        cost_price: costPrice,
        product_name: productName
    };

    fetch('/api/update_product_price', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.success) {
            alert('✅ 更新成功，已同步发货明细中的申报价格与商品信息');
            bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
            setTimeout(() => location.reload(), 600);
        } else {
            alert('更新失败: ' + (data.error || JSON.stringify(data)));
        }
    })
    .catch(err => {
        console.error(err);
        alert('更新出错，请查看控制台');
    });
}

// 添加新商品
function submitAddProduct() {
    const shop = document.getElementById('addShop').value;
    const spu = document.getElementById('addSpuId').value;
    const productName = document.getElementById('addProductName').value;
    const skuAttribute = document.getElementById('addSkuAttribute').value;
    const skuId = document.getElementById('addSkuId').value;
    const unitPrice = parseFloat(document.getElementById('addUnitPrice').value || 0);
    const costPrice = parseFloat(document.getElementById('addCostPrice').value || 0);

    if (!shop || !spu || !productName || !skuAttribute) {
        alert('请填写所有必填字段');
        return;
    }

    const payload = {
        shop_name: shop,
        spu_id: spu,
        sku_attribute: skuAttribute,
        sku_id: skuId,
        unit_price: unitPrice,
        cost_price: costPrice,
        product_name: productName
    };

    // 注意：这里需要一个新增商品的API，目前没有
    // 暂时使用更新价格的API（会创建新的记录）
    fetch('/api/update_product_price', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.success) {
            alert('商品添加成功');
            bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
            document.getElementById('addProductForm').reset();
            setTimeout(() => location.reload(), 600);
        } else {
            alert('添加失败: ' + (data.error || JSON.stringify(data)));
        }
    })
    .catch(err => {
        console.error(err);
        alert('添加出错，请查看控制台');
    });
}

// 同步商品价格到发货明细
function syncShippingPrices() {
    const shop = document.getElementById('editShop').value;
    const spu = document.getElementById('editSpuId').value;
    const skuAttribute = document.getElementById('editSkuAttribute').value;
    
    if (!shop || !spu || !skuAttribute) {
        alert('请先选择商品规格');
        return;
    }
    
    if (!confirm(`确定要将 ${spu} (${skuAttribute}) 的商品价格同步到所有发货明细吗？\n\n这会更新所有相关发货订单的单价和总金额。`)) {
        return;
    }
    
    // 获取当前输入的价格
    const unitPrice = parseFloat(document.getElementById('editUnitPrice').value || 0);
    const costPrice = parseFloat(document.getElementById('editCostPrice').value || 0);
    const productName = document.getElementById('editProductName').value;
    
    // 先更新商品价格
    const payload = {
        shop_name: shop,
        spu_id: spu,
        sku_attribute: skuAttribute,
        unit_price: unitPrice,
        cost_price: costPrice,
        product_name: productName
    };
    
    fetch('/api/update_product_price', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.success) {
            // 再调用同步API
            return fetch('/api/sync_shipping_prices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    shop_name: shop,
                    spu_id: spu,
                    sku_attribute: skuAttribute  // 可以添加这个参数只同步特定规格
                })
            });
        } else {
            throw new Error('更新商品价格失败: ' + data.error);
        }
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.success) {
            alert(`✅ 同步成功！已更新 ${data.updated_count || '所有'} 条发货明细记录。`);
            // 可以刷新页面显示最新数据
            setTimeout(() => location.reload(), 1000);
        } else {
            alert('同步失败: ' + (data.error || '未知错误'));
        }
    })
    .catch(err => {
        console.error(err);
        alert('同步出错: ' + err.message);
    });
}

// 初始化页面时启用 tooltip
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'))
    tooltipTriggerList.forEach(function (el) {
        new bootstrap.Tooltip(el, {container: 'body', trigger: 'hover'});
    })
});
</script>
{% endblock %}