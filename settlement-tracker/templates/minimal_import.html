{% extends "minimal_base.html" %}

{% block title %}æ•°æ®å¯¼å…¥ - ç»´é²¸è¿è¥ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="mb-5">
        <h1 class="h2 fw-bold mb-2">æ•°æ®å¯¼å…¥</h1>
        <p class="text-gray-600">å¯¼å…¥äº¤æ˜“ç»“ç®—ã€å”®åé—®é¢˜ã€å‘è´§æ˜ç»†ç­‰æ•°æ®</p>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- å¯¼å…¥è¡¨å• -->
            <div class="minimal-card mb-4">
                <div class="minimal-card-header">
                    <h4 class="mb-0">é€‰æ‹©æ•°æ®ç±»å‹å’Œæ–‡ä»¶</h4>
                </div>
                <div class="minimal-card-body">
                    <form id="importForm">
                        <!-- æ•°æ®ç±»å‹é€‰æ‹© -->
                        <div class="mb-4">
                            <h5 class="mb-3">1. é€‰æ‹©æ•°æ®ç±»å‹</h5>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="form-check-card" onclick="selectDataType('transactions')">
                                        <input type="radio" name="data_type" id="transactions" value="transactions" class="d-none" checked>
                                        <div class="card border p-3 text-center" style="cursor: pointer; border-radius: 10px;">
                                            <div class="mb-3" style="width: 48px; height: 48px; margin: 0 auto; background-color: rgba(37, 99, 235, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-money-bill-wave text-primary"></i>
                                            </div>
                                            <h6 class="mb-1">äº¤æ˜“ç»“ç®—æ•°æ®</h6>
                                            <p class="text-gray-600 small mb-0">é”€å”®å›æ¬¾ã€é”€å”®å†²å›ã€éå•†è´£è¡¥è´´</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check-card" onclick="selectDataType('after_sales')">
                                        <input type="radio" name="data_type" id="after_sales" value="after_sales" class="d-none">
                                        <div class="card border p-3 text-center" style="cursor: pointer; border-radius: 10px;">
                                            <div class="mb-3" style="width: 48px; height: 48px; margin: 0 auto; background-color: rgba(239, 68, 68, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-headset text-danger"></i>
                                            </div>
                                            <h6 class="mb-1">å”®åé—®é¢˜æ•°æ®</h6>
                                            <p class="text-gray-600 small mb-0">è¿è§„IDã€èµ”ä»˜é‡‘é¢ç­‰ä¿¡æ¯</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check-card" onclick="selectDataType('shipping')">
                                        <input type="radio" name="data_type" id="shipping" value="shipping" class="d-none">
                                        <div class="card border p-3 text-center" style="cursor: pointer; border-radius: 10px;">
                                            <div class="mb-3" style="width: 48px; height: 48px; margin: 0 auto; background-color: rgba(16, 185, 129, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-shipping-fast text-success"></i>
                                            </div>
                                            <h6 class="mb-1">å‘è´§æ˜ç»†æ•°æ®</h6>
                                            <p class="text-gray-600 small mb-0">å¤‡è´§å•å·ã€å•†å“ä¿¡æ¯ã€å‘è´§æ•°é‡</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- åº—é“ºé€‰æ‹© -->
                        <div class="mb-4">
                            <h5 class="mb-3">2. é€‰æ‹©åº—é“º</h5>
                            <select class="form-select search-input" id="shopSelect" required>
                                <option value="">-- è¯·é€‰æ‹©åº—é“º --</option>
                                {% for shop in shops %}
                                    {% if shop != "æ±‡æ€»" %}
                                    <option value="{{ shop }}">{{ shop }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <!-- æ–‡ä»¶ä¸Šä¼  -->
                        <div class="mb-4">
                            <h5 class="mb-3">3. ä¸Šä¼ æ–‡ä»¶</h5>
                            <div class="upload-area" id="uploadArea">
                                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" class="d-none">
                                <div class="upload-icon" style="font-size: 48px; margin-bottom: 1rem;">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h5 class="mb-2">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤åŒºåŸŸ</h5>
                                <p class="text-muted mb-3">æ”¯æŒCSVå’ŒExcelæ ¼å¼æ–‡ä»¶ï¼ˆ.csv, .xlsx, .xlsï¼‰</p>
                                <div class="file-name" id="fileName">
                                    <span class="text-gray-500">æœªé€‰æ‹©æ–‡ä»¶</span>
                                </div>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-minimal" style="background-color: var(--gray-200); color: var(--gray-700);" onclick="document.getElementById('fileInput').click()">
                                        <i class="fas fa-folder-open me-2"></i>é€‰æ‹©æ–‡ä»¶
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- å¯¼å…¥æŒ‰é’® -->
                        <div class="d-grid">
                            <button type="button" class="btn btn-minimal btn-minimal-primary btn-lg" id="importBtn" onclick="submitImport()">
                                <span id="importText">å¼€å§‹å¯¼å…¥æ•°æ®</span>
                                <span id="importSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- å³ä¾§è¯´æ˜ -->
        <div class="col-lg-4">
            <div class="minimal-card sticky-top" style="top: 20px;">
                <div class="minimal-card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>å¯¼å…¥è¯´æ˜</h5>
                </div>
                <div class="minimal-card-body">
                    <div class="mb-4">
                        <h6 class="mb-2">ğŸ“„ æ–‡ä»¶æ ¼å¼è¦æ±‚ï¼š</h6>
                        <ul class="list-unstyled mb-0">
                            <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>CSVæ ¼å¼ï¼ˆUTF-8ç¼–ç ï¼‰</li>
                            <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>Excelæ ¼å¼ï¼ˆ.xlsx, .xlsï¼‰</li>
                            <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>ç¬¬ä¸€è¡Œä¸ºåˆ—æ ‡é¢˜</li>
                            <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>æ”¯æŒExcelç›´æ¥å¯¼å‡º</li>
                        </ul>
                    </div>

                    <div class="mb-4">
                        <h6 class="mb-2">ğŸ’° äº¤æ˜“ç»“ç®—æ•°æ®ï¼š</h6>
                        <p class="small mb-2">å¿…éœ€åˆ—ï¼š</p>
                        <code class="d-block bg-light p-2 rounded mb-3 small">å¤‡è´§å•å·, SKU ID, æ•°é‡, é‡‘é¢, äº¤æ˜“ç±»å‹</code>
                    </div>

                    <div class="mb-4">
                        <h6 class="mb-2">ğŸ›¡ï¸ å”®åé—®é¢˜æ•°æ®ï¼š</h6>
                        <p class="small mb-2">å¿…éœ€åˆ—ï¼š</p>
                        <code class="d-block bg-light p-2 rounded mb-3 small">è¿è§„ID, SKU ID, èµ”ä»˜é‡‘é¢, è´¦åŠ¡æ—¶é—´</code>
                    </div>

                    <div class="mb-4">
                        <h6 class="mb-2">ğŸ“¦ å‘è´§æ˜ç»†æ•°æ®ï¼š</h6>
                        <p class="small mb-2">å¿…éœ€åˆ—ï¼š</p>
                        <code class="d-block bg-light p-2 rounded mb-3 small">å¤‡è´§å•, å•†å“SPU ID, å•†å“SKU ID, å•†å“åç§°</code>
                    </div>

                    <div class="alert alert-info mt-3">
                        <div class="d-flex">
                            <i class="fas fa-lightbulb me-2 mt-1"></i>
                            <div>
                                <strong class="d-block mb-1">ğŸ’¡ æç¤º</strong>
                                <ul class="small mb-0 ps-3">
                                    <li>ç³»ç»Ÿä¼šè‡ªåŠ¨å»é‡ï¼Œé‡å¤æ•°æ®ä¸ä¼šé‡å¤å¯¼å…¥</li>
                                    <li>æ”¯æŒExcelå’ŒCSVä¸¤ç§æ ¼å¼</li>
                                    <li>å¯¼å…¥åè¯·åˆ°"æ•°æ®çœ‹æ¿"æŸ¥çœ‹æ•ˆæœ</li>
                                    <li>æ”¯æŒåˆ†æ‰¹å¯¼å…¥ï¼ŒæŒ‰æ—¥æœŸæˆ–åº—é“ºç­›é€‰åå¯¼å…¥</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥ç»“æœæ¨¡æ€æ¡† -->
    <div class="modal fade" id="importResultModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å¯¼å…¥ç»“æœ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="importResultContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-minimal" data-bs-dismiss="modal">å…³é—­</button>
                    <a href="/dashboard" class="btn btn-minimal btn-minimal-primary">æŸ¥çœ‹çœ‹æ¿</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// å½“å‰é€‰ä¸­çš„æ•°æ®ç±»å‹
let currentDataType = 'transactions';

function selectDataType(type) {
    currentDataType = type;
    
    // æ›´æ–°å¡ç‰‡é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.form-check-card .card').forEach(card => {
        card.style.borderColor = 'var(--gray-300)';
        card.style.backgroundColor = 'white';
    });
    
    event.currentTarget.querySelector('.card').style.borderColor = 'var(--primary-color)';
    event.currentTarget.querySelector('.card').style.backgroundColor = 'rgba(37, 99, 235, 0.05)';
    
    // æ›´æ–°å•é€‰æŒ‰é’®
    document.getElementById(type).checked = true;
}

// æ–‡ä»¶ä¸Šä¼ å¤„ç†
document.getElementById('uploadArea').addEventListener('click', function() {
    document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const allowedExtensions = ['.csv', '.xlsx', '.xls'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!allowedExtensions.includes(fileExtension)) {
            alert('è¯·é€‰æ‹©CSVæˆ–Excelæ ¼å¼çš„æ–‡ä»¶ï¼ˆ.csv, .xlsx, .xlsï¼‰');
            return;
        }
        
        document.getElementById('fileName').innerHTML = `
            <i class="fas fa-file-excel text-success me-2"></i>
            <span class="text-success">${file.name}</span>
            <small class="text-gray-500 ms-2">(${(file.size / 1024 / 1024).toFixed(2)} MB)</small>
        `;
    }
});

// æ‹–æ‹½ä¸Šä¼ 
document.getElementById('uploadArea').addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
});

document.getElementById('uploadArea').addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
});

document.getElementById('uploadArea').addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    
    const file = e.dataTransfer.files[0];
    if (file) {
        const allowedExtensions = ['.csv', '.xlsx', '.xls'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (allowedExtensions.includes(fileExtension)) {
            document.getElementById('fileInput').files = e.dataTransfer.files;
            document.getElementById('fileName').innerHTML = `
                <i class="fas fa-file-excel text-success me-2"></i>
                <span class="text-success">${file.name}</span>
                <small class="text-gray-500 ms-2">(${(file.size / 1024 / 1024).toFixed(2)} MB)</small>
            `;
        } else {
            alert('è¯·é€‰æ‹©CSVæˆ–Excelæ ¼å¼çš„æ–‡ä»¶ï¼ˆ.csv, .xlsx, .xlsï¼‰');
        }
    }
});

// æäº¤å¯¼å…¥
function submitImport() {
    const shopSelect = document.getElementById('shopSelect');
    const fileInput = document.getElementById('fileInput');
    const importBtn = document.getElementById('importBtn');
    const importText = document.getElementById('importText');
    const importSpinner = document.getElementById('importSpinner');
    
    if (!shopSelect.value) {
        alert('è¯·é€‰æ‹©åº—é“º');
        return;
    }
    
    if (!fileInput.files[0]) {
        alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    importBtn.disabled = true;
    importText.textContent = 'æ­£åœ¨å¯¼å…¥...';
    importSpinner.style.display = 'inline-block';
    
    // åˆ›å»ºFormData
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('shop_name', shopSelect.value);
    formData.append('data_type', currentDataType);
    
    // å‘é€è¯·æ±‚
    fetch('/import', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // æ˜¾ç¤ºç»“æœ
        if (data.success) {
            document.getElementById('importResultContent').innerHTML = `
                <div class="text-center py-3">
                    <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                    <h5 class="mb-2">å¯¼å…¥æˆåŠŸï¼</h5>
                    <p class="mb-0">${data.message}</p>
                </div>
            `;
        } else {
            document.getElementById('importResultContent').innerHTML = `
                <div class="text-center py-3">
                    <i class="fas fa-times-circle text-danger fa-3x mb-3"></i>
                    <h5 class="mb-2">å¯¼å…¥å¤±è´¥</h5>
                    <p class="mb-0">${data.error}</p>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºç»“æœæ¨¡æ€æ¡†
        new bootstrap.Modal(document.getElementById('importResultModal')).show();
    })
    .catch(error => {
        console.error('å¯¼å…¥å¤±è´¥:', error);
        document.getElementById('importResultContent').innerHTML = `
            <div class="text-center py-3">
                <i class="fas fa-times-circle text-danger fa-3x mb-3"></i>
                <h5 class="mb-2">å¯¼å…¥å¤±è´¥</h5>
                <p class="mb-0">ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</p>
            </div>
        `;
        new bootstrap.Modal(document.getElementById('importResultModal')).show();
    })
    .finally(() => {
        // é‡ç½®æŒ‰é’®çŠ¶æ€
        importBtn.disabled = false;
        importText.textContent = 'å¼€å§‹å¯¼å…¥æ•°æ®';
        importSpinner.style.display = 'none';
    });
}

// é¡µé¢åŠ è½½æ—¶é€‰ä¸­ç¬¬ä¸€ä¸ªæ•°æ®ç±»å‹
document.addEventListener('DOMContentLoaded', function() {
    selectDataType('transactions');
});
</script>
{% endblock %}
EOF