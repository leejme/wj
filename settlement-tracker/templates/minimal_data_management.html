{% extends "minimal_base.html" %}

{% block title %}数据管理 - 维鲸运营系统{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- 页面标题 -->
    <div class="mb-5">
        <h1 class="h2 fw-bold mb-2">数据管理</h1>
        <p class="text-gray-600">查看系统状态，管理数据</p>
    </div>

    <!-- 数据库状态卡片 -->
    <div class="row mb-5">
        <div class="col-md-3 mb-4">
            <div class="stat-card">
                <div class="stat-icon" style="background-color: rgba(37, 99, 235, 0.1); color: var(--primary-color);">
                    <i class="fas fa-exchange-alt fa-lg"></i>
                </div>
                <div class="stat-value">{{ debug_info.transaction_count if debug_info else 0 }}</div>
                <div class="stat-label">交易结算记录</div>
                <div class="stat-subtext">
                    {% if debug_info and debug_info.transaction_dates %}
                    最新: {{ debug_info.transaction_dates[0] if debug_info.transaction_dates else '无' }}
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="stat-card">
                <div class="stat-icon" style="background-color: rgba(239, 68, 68, 0.1); color: var(--danger-color);">
                    <i class="fas fa-headset fa-lg"></i>
                </div>
                <div class="stat-value">{{ debug_info.after_sales_count if debug_info else 0 }}</div>
                <div class="stat-label">售后问题记录</div>
                <div class="stat-subtext">
                    {% if debug_info and debug_info.after_sales_dates %}
                    最新: {{ debug_info.after_sales_dates[0] if debug_info.after_sales_dates else '无' }}
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="stat-card">
                <div class="stat-icon" style="background-color: rgba(16, 185, 129, 0.1); color: var(--success-color);">
                    <i class="fas fa-shipping-fast fa-lg"></i>
                </div>
                <div class="stat-value">{{ debug_info.shipping_count if debug_info else 0 }}</div>
                <div class="stat-label">发货明细记录</div>
                <div class="stat-subtext">
                    {% if debug_info and debug_info.shipping_dates %}
                    最新: {{ debug_info.shipping_dates[0] if debug_info.shipping_dates else '无' }}
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="stat-card">
                <div class="stat-icon" style="background-color: rgba(245, 158, 11, 0.1); color: var(--warning-color);">
                    <i class="fas fa-box fa-lg"></i>
                </div>
                <div class="stat-value">{{ debug_info.product_count if debug_info else 0 }}</div>
                <div class="stat-label">商品价格记录</div>
                <div class="stat-subtext">
                    {% if debug_info and debug_info.product_count %}
                    {{ debug_info.product_count }} 个商品
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 数据日期范围 -->
        <div class="col-md-6 mb-4">
            <div class="minimal-card h-100">
                <div class="minimal-card-header">
                    <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>数据日期范围</h5>
                </div>
                <div class="minimal-card-body">
                    <div class="mb-4">
                        <h6 class="mb-3">交易结算数据</h6>
                        <div class="list-group list-group-flush">
                            {% if transaction_dates and transaction_dates|length > 0 %}
                            <div class="list-group-item d-flex justify-content-between">
                                <span>最早日期</span>
                                <span class="fw-medium">{{ transaction_dates[-1] if transaction_dates else '无' }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span>最新日期</span>
                                <span class="fw-medium">{{ transaction_dates[0] if transaction_dates else '无' }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span>总天数</span>
                                <span class="fw-medium">{{ transaction_dates|length }} 天</span>
                            </div>
                            {% else %}
                            <div class="list-group-item">
                                <div class="text-center py-3 text-gray-500">
                                    <i class="fas fa-inbox fa-2x mb-2"></i>
                                    <p class="mb-0">暂无交易数据</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-4">
                        <h6 class="mb-3">售后问题数据</h6>
                        <div class="list-group list-group-flush">
                            {% if after_sales_dates and after_sales_dates|length > 0 %}
                            <div class="list-group-item d-flex justify-content-between">
                                <span>最早日期</span>
                                <span class="fw-medium">{{ after_sales_dates[-1] if after_sales_dates else '无' }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span>最新日期</span>
                                <span class="fw-medium">{{ after_sales_dates[0] if after_sales_dates else '无' }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span>总天数</span>
                                <span class="fw-medium">{{ after_sales_dates|length }} 天</span>
                            </div>
                            {% else %}
                            <div class="list-group-item">
                                <div class="text-center py-3 text-gray-500">
                                    <i class="fas fa-headset fa-2x mb-2"></i>
                                    <p class="mb-0">暂无售后数据</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div>
                        <h6 class="mb-3">发货明细数据</h6>
                        <div class="list-group list-group-flush">
                            {% if shipping_dates and shipping_dates|length > 0 %}
                            <div class="list-group-item d-flex justify-content-between">
                                <span>最早日期</span>
                                <span class="fw-medium">{{ shipping_dates[-1] if shipping_dates else '无' }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span>最新日期</span>
                                <span class="fw-medium">{{ shipping_dates[0] if shipping_dates else '无' }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span>总天数</span>
                                <span class="fw-medium">{{ shipping_dates|length }} 天</span>
                            </div>
                            {% else %}
                            <div class="list-group-item">
                                <div class="text-center py-3 text-gray-500">
                                    <i class="fas fa-truck fa-2x mb-2"></i>
                                    <p class="mb-0">暂无发货数据</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系统维护 -->
        <div class="col-md-6 mb-4">
            <div class="minimal-card h-100">
                <div class="minimal-card-header">
                    <h5 class="mb-0"><i class="fas fa-tools me-2"></i>系统维护</h5>
                </div>
                <div class="minimal-card-body">
                    <div class="alert alert-warning mb-4">
                        <div class="d-flex">
                            <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                            <div>
                                <strong class="d-block mb-1">⚠️ 警告</strong>
                                <p class="mb-0 small">以下操作会永久删除数据，请谨慎操作！</p>
                            </div>
                        </div>
                    </div>

                    <!-- 数据库初始化 -->
                    <div class="mb-4">
                        <h6 class="mb-3">数据库管理</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-minimal" style="background-color: var(--gray-200); color: var(--gray-700);" onclick="initDatabase()">
                                <i class="fas fa-database me-2"></i>初始化数据库
                            </button>
                            <button class="btn btn-minimal" style="background-color: rgba(239, 68, 68, 0.1); color: var(--danger-color);" onclick="showClearDataModal()">
                                <i class="fas fa-trash-alt me-2"></i>清除所有数据
                            </button>
                        </div>
                    </div>

                    <!-- 数据导出 -->
                    <div class="mb-4">
                        <h6 class="mb-3">数据导出</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-minimal" style="background-color: rgba(37, 99, 235, 0.1); color: var(--primary-color);" onclick="exportData('transactions')">
                                <i class="fas fa-file-export me-2"></i>导出交易数据
                            </button>
                            <button class="btn btn-minimal" style="background-color: rgba(239, 68, 68, 0.1); color: var(--danger-color);" onclick="exportData('after_sales')">
                                <i class="fas fa-file-export me-2"></i>导出售后数据
                            </button>
                            <button class="btn btn-minimal" style="background-color: rgba(16, 185, 129, 0.1); color: var(--success-color);" onclick="exportData('shipping')">
                                <i class="fas fa-file-export me-2"></i>导出发货数据
                            </button>
                        </div>
                    </div>

                    <!-- 系统信息 -->
                    <div>
                        <h6 class="mb-3">系统信息</h6>
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex justify-content-between">
                                <span>店铺数量</span>
                                <span class="fw-medium">{{ shops|length if shops else 0 }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span>数据库文件</span>
                                <span class="fw-medium">settlement_system.db</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span>最后更新时间</span>
                                <span class="fw-medium">{{ debug_info.update_time if debug_info else '未知' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 清除数据确认模态框 -->
    <div class="modal fade" id="clearDataModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger"><i class="fas fa-exclamation-triangle me-2"></i>确认清除数据</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center py-3">
                        <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                        <h5 class="mb-3">您确定要清除所有数据吗？</h5>
                        <p class="text-gray-600 mb-0">此操作将永久删除所有交易、售后、发货、商品等数据，且无法恢复！</p>
                    </div>
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        请输入 "<strong>DELETE_ALL_DATA</strong>" 以确认操作
                    </div>
                    <input type="text" class="form-control mb-3" id="confirmInput" placeholder="输入确认文字">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-minimal" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-minimal" style="background-color: var(--danger-color); color: white;" onclick="clearAllData()" disabled id="clearBtn">
                        清除所有数据
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 监听确认输入
document.getElementById('confirmInput')?.addEventListener('input', function(e) {
    const clearBtn = document.getElementById('clearBtn');
    clearBtn.disabled = e.target.value !== 'DELETE_ALL_DATA';
});

function showClearDataModal() {
    new bootstrap.Modal(document.getElementById('clearDataModal')).show();
}

function clearAllData() {
    const confirmInput = document.getElementById('confirmInput');
    if (confirmInput.value !== 'DELETE_ALL_DATA') {
        alert('请输入正确的确认文字');
        return;
    }

    // 发送清除请求
    fetch('/api/clear_data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('数据已清除！页面将重新加载。');
            window.location.reload();
        } else {
            alert('清除失败: ' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        alert('清除失败: ' + error);
    })
    .finally(() => {
        // 关闭模态框
        bootstrap.Modal.getInstance(document.getElementById('clearDataModal')).hide();
    });
}

function initDatabase() {
    if (confirm('确定要初始化数据库吗？这不会删除现有数据，只会创建缺失的表。')) {
        fetch('/init_db')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('数据库初始化成功！');
                    window.location.reload();
                } else {
                    alert('初始化失败: ' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                alert('初始化失败: ' + error);
            });
    }
}

function exportData(type) {
    let url = '';
    let filename = '';
    
    switch(type) {
        case 'transactions':
            url = '/export/orders';
            filename = '交易数据.csv';
            break;
        case 'after_sales':
            url = '/export/after_sales';
            filename = '售后数据.csv';
            break;
        case 'shipping':
            url = '/export/shipping';
            filename = '发货数据.csv';
            break;
        default:
            alert('不支持的类型');
            return;
    }
    
    // 创建隐藏的iframe来下载文件
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = url;
    document.body.appendChild(iframe);
    
    // 5秒后移除iframe
    setTimeout(() => {
        document.body.removeChild(iframe);
    }, 5000);
}
</script>
{% endblock %}
EOF