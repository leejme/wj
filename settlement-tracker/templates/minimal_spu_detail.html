{% extends "minimal_base.html" %}

{% block title %}SPU详情 - 维鲸运营系统{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- 页面标题 -->
    <div class="mb-5">
        <h1 class="h2 fw-bold mb-2">SPU详情</h1>
        <p class="text-gray-600">{{ spu_id }} - {{ product_name }}</p>
        <a href="/products" class="text-primary text-decoration-none">
            <i class="fas fa-arrow-left me-2"></i>返回商品列表
        </a>
    </div>

    <!-- SPU基本信息 -->
    <div class="minimal-card mb-4">
        <div class="minimal-card-header">
            <h4 class="mb-0">基本信息</h4>
        </div>
        <div class="minimal-card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label text-gray-600">SPU ID</label>
                        <div class="fw-bold">{{ spu_id }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label text-gray-600">店铺</label>
                        <div class="fw-bold">{{ shop_name }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label text-gray-600">商品名称</label>
                        <div class="fw-bold">{{ product_name }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 规格列表 -->
    <div class="minimal-card">
        <div class="minimal-card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">规格列表</h4>
            <button class="btn btn-minimal btn-minimal-primary" onclick="addNewSpec()">
                <i class="fas fa-plus me-2"></i>添加规格
            </button>
        </div>
        <div class="minimal-card-body">
            {% if skus and skus|length > 0 %}
            <div class="table-responsive">
                <table class="minimal-table">
                    <thead>
                        <tr>
                            <th>规格</th>
                            <th>SKU ID</th>
                            <th>申报价格</th>
                            <th>成本单价</th>
                            <th>已售数量</th>
                            <th>最后更新</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sku in skus %}
                        <tr>
                            <td>
                                <span class="badge-minimal" style="background-color: var(--gray-100); color: var(--gray-700);">
                                    {{ sku.sku_attribute }}
                                </span>
                            </td>
                            <td><small class="text-gray-500">{{ sku.sku_id }}</small></td>
                            <td class="fw-bold text-success">¥{{ "%.2f"|format(sku.unit_price) }}</td>
                            <td class="text-gray-600">¥{{ "%.2f"|format(sku.cost_price) }}</td>
                            <td><span class="fw-medium">{{ sku.total_sold or 0 }}</span></td>
                            <td><small class="text-gray-500">{{ sku.update_date[:10] if sku.update_date else '' }}</small></td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm" style="background-color: rgba(37, 99, 235, 0.1); color: var(--primary-color);" onclick="editSpec(this)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5 text-gray-500">
                <i class="fas fa-boxes fa-2x mb-3"></i><br>
                暂无规格数据
                <div class="mt-3">
                    <button class="btn btn-minimal btn-minimal-primary" onclick="addNewSpec()">
                        <i class="fas fa-plus me-2"></i>添加第一个规格
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 编辑规格模态框 -->
<div class="modal fade" id="editSpecModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑规格</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editSpecForm">
                    <input type="hidden" id="editSpecSkuAttribute">
                    
                    <div class="mb-3">
                        <label class="form-label">规格名称</label>
                        <input type="text" id="editSpecDisplay" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">申报价格 (¥)</label>
                        <input type="number" step="0.01" id="editSpecUnitPrice" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">成本单价 (¥)</label>
                        <input type="number" step="0.01" id="editSpecCostPrice" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-minimal" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-minimal btn-minimal-primary" onclick="saveSpecEdit()">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function editSpec(btn) {
    const tr = btn.closest('tr');
    const cells = tr.querySelectorAll('td');
    
    const skuAttribute = cells[0].querySelector('.badge-minimal').textContent.trim();
    const unitPriceText = cells[2].textContent.replace('¥','').trim();
    const costPriceText = cells[3].textContent.replace('¥','').trim();

    document.getElementById('editSpecSkuAttribute').value = skuAttribute;
    document.getElementById('editSpecDisplay').value = skuAttribute;
    document.getElementById('editSpecUnitPrice').value = unitPriceText || 0;
    document.getElementById('editSpecCostPrice').value = costPriceText || 0;

    new bootstrap.Modal(document.getElementById('editSpecModal')).show();
}

function saveSpecEdit() {
    const skuAttribute = document.getElementById('editSpecSkuAttribute').value;
    const unitPrice = parseFloat(document.getElementById('editSpecUnitPrice').value || 0);
    const costPrice = parseFloat(document.getElementById('editSpecCostPrice').value || 0);

    if (!skuAttribute) {
        alert('缺少必要字段');
        return;
    }

    const payload = {
        shop_name: "{{ shop_name }}",
        spu_id: "{{ spu_id }}",
        sku_attribute: skuAttribute,
        unit_price: unitPrice,
        cost_price: costPrice,
        product_name: "{{ product_name }}"
    };

    fetch('/api/update_product_price', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.success) {
            alert('更新成功');
            bootstrap.Modal.getInstance(document.getElementById('editSpecModal')).hide();
            setTimeout(() => location.reload(), 600);
        } else {
            alert('更新失败: ' + (data.error || JSON.stringify(data)));
        }
    })
    .catch(err => {
        console.error(err);
        alert('更新出错');
    });
}

function addNewSpec() {
    alert('添加规格功能需要单独实现');
}
</script>
{% endblock %}